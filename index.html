<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>×§×•×¤×” ×§×œ×” â€“ × ×™×”×•×œ ×›×¡×¤×™× ×™×•××™</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --brand:#6366f1; --ok:#10b981; --warn:#f59e0b; --bad:#ef4444; }
    html,body{ height:100%; }
    body{ font-family: 'Heebo', system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial,"Noto Sans", "Apple Color Emoji","Segoe UI Emoji"; }
    .glass{ background: rgba(255,255,255,0.65); backdrop-filter: blur(8px); }
    .dark .glass{ background: rgba(17,24,39,0.55); }
    .tab-active{ color:#111827; border-color: var(--brand); }
    .dark .tab-active{ color:#f9fafb; }
    .ring-brand{ box-shadow:0 0 0 3px rgba(99,102,241,0.35) }
    .btn{ @apply px-4 py-3 rounded-2xl font-medium shadow-sm transition active:scale-[.98]; }
    .btn-primary{ background:var(--brand); color:white; }
    .btn-ghost{ @apply bg-transparent; }
    .pill{ @apply text-sm px-2 py-1 rounded-full; }
    .toast{ position: fixed; inset-inline:0; bottom: 82px; display:flex; justify-content:center; pointer-events:none; }
    .toast > div{ pointer-events:auto; }
    .progress{ height:10px; border-radius:999px; background:rgba(0,0,0,.08); overflow:hidden }
    .dark .progress{ background:rgba(255,255,255,.12) }
    .progress > span{ display:block; height:100%; background:linear-gradient(90deg, var(--brand), #22d3ee); }
    .card{ @apply rounded-3xl p-4 shadow-md glass; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100">
  <div id="app" class="min-h-screen flex flex-col">
    <!-- Top Bar -->
    <header class="sticky top-0 z-20 bg-gradient-to-b from-indigo-500/90 to-indigo-400/60 dark:from-indigo-700/70 dark:to-indigo-600/40 text-white">
      <div class="max-w-screen-sm mx-auto px-4 py-3 flex items-center gap-3">
        <button id="themeBtn" class="pill bg-white/20 hover:bg-white/30">ğŸŒ“ ××¦×‘</button>
        <h1 class="text-xl font-bold flex-1 text-center">×§×•×¤×” ×§×œ×”</h1>
        <button id="settingsBtn" class="pill bg-white/20 hover:bg-white/30">âš™ï¸</button>
      </div>
      <div class="max-w-screen-sm mx-auto px-4 pb-3 -mt-2">
        <p id="monthLabel" class="text-sm/6 opacity-90"></p>
      </div>
    </header>

    <!-- Main Views -->
    <main class="flex-1 max-w-screen-sm mx-auto w-full px-3 py-3 space-y-3">
      <!-- Quick Add -->
      <section id="view-add" class="space-y-3">
        <div class="card">
          <div class="flex items-center gap-2">
            <button data-kind="expense" class="kindBtn btn flex-1 bg-rose-500/90 text-white">×”×•×¦××”</button>
            <button data-kind="income" class="kindBtn btn flex-1 bg-emerald-500/90 text-white">×”×›× ×¡×”</button>
          </div>
          <form id="quickForm" class="mt-3 grid grid-cols-2 gap-3" autocomplete="off">
            <div class="col-span-2">
              <label class="block text-sm mb-1">×¡×›×•× (â‚ª)</label>
              <input id="amount" type="number" inputmode="decimal" min="0" step="0.01" class="w-full rounded-2xl px-4 py-3 bg-white/80 dark:bg-slate-800/70 outline-none focus:ring-2 ring-brand" placeholder="×œ×“×•×’××”: 35" required />
            </div>
            <div class="col-span-1">
              <label class="block text-sm mb-1">×§×˜×’×•×¨×™×”</label>
              <select id="category" class="w-full rounded-2xl px-3 py-3 bg-white/80 dark:bg-slate-800/70 outline-none focus:ring-2 ring-brand"></select>
              <button id="addCategoryBtn" type="button" class="mt-1 text-xs text-indigo-600">â• ×”×•×¡×¤×ª ×§×˜×’×•×¨×™×”</button>
            </div>
            <div class="col-span-1">
              <label class="block text-sm mb-1">×ª××¨×™×š</label>
              <input id="date" type="date" class="w-full rounded-2xl px-3 py-3 bg-white/80 dark:bg-slate-800/70 outline-none focus:ring-2 ring-brand" />
            </div>
            <div class="col-span-2">
              <label class="block text-sm mb-1">×ª×™××•×¨ (×œ× ×—×•×‘×”)</label>
              <input id="note" class="w-full rounded-2xl px-4 py-3 bg-white/80 dark:bg-slate-800/70 outline-none focus:ring-2 ring-brand" placeholder="×œ×“×•×’××”: ×§×¤×”, × ×¡×™×¢×”, ××œ×’×”..." />
            </div>
            <div class="col-span-2 flex items-center gap-2">
              <input id="saveTemplate" type="checkbox" class="scale-125">
              <label for="saveTemplate" class="text-sm">×©××•×¨ ×›×ª×‘× ×™×ª ×œ×—×–×¨×” ××”×™×¨×”</label>
            </div>
            <div class="col-span-2">
              <button class="btn btn-primary w-full" type="submit">ğŸ’¾ ×©××™×¨×” ××”×™×¨×”</button>
            </div>
          </form>
        </div>

        <!-- Quick Templates -->
        <div class="card" id="templatesCard" hidden>
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold">×©×™××•×© ××”×™×¨ ×‘×¤×¢×•×œ×•×ª ×—×•×–×¨×•×ª</h3>
            <button id="clearTemplates" class="text-xs text-rose-400">× ×§×” ×ª×‘× ×™×•×ª</button>
          </div>
          <div id="templatesList" class="flex flex-wrap gap-2"></div>
        </div>

        <!-- Snapshot -->
        <div class="grid grid-cols-3 gap-3">
          <div class="card text-center">
            <div class="text-sm opacity-80">×”×›× ×¡×•×ª ×‘×—×•×“×©</div>
            <div id="sumIncome" class="text-xl font-bold">â‚ª0</div>
          </div>
          <div class="card text-center">
            <div class="text-sm opacity-80">×”×•×¦××•×ª ×‘×—×•×“×©</div>
            <div id="sumExpense" class="text-xl font-bold">â‚ª0</div>
          </div>
          <div class="card text-center">
            <div class="text-sm opacity-80">×™×ª×¨×” × ×•×›×—×™×ª</div>
            <div id="balance" class="text-xl font-bold">â‚ª0</div>
          </div>
        </div>

        <!-- Budget glance -->
        <div class="card">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold">×ª×§×¦×™×‘ ×—×•×“×©×™ â€“ ××‘×˜ ××”×™×¨</h3>
            <button class="pill bg-indigo-100 text-indigo-700 dark:bg-indigo-900/40 dark:text-indigo-200" data-nav="budget">× ×™×”×•×œ ×ª×§×¦×™×‘</button>
          </div>
          <div id="budgetGlance" class="space-y-3"></div>
        </div>
      </section>

      <!-- Reports -->
      <section id="view-reports" class="space-y-3 hidden">
        <div class="card">
          <h3 class="font-semibold mb-2">×¤×™×œ×•×— ×”×•×¦××•×ª ×œ×¤×™ ×§×˜×’×•×¨×™×•×ª (×”×—×•×“×©)</h3>
          <canvas id="pieCats" height="200"></canvas>
        </div>
        <div class="card">
          <h3 class="font-semibold mb-2">××’××” ×™×•××™×ª × ×˜×• (×”×—×•×“×©)</h3>
          <canvas id="lineDaily" height="200"></canvas>
        </div>
      </section>

      <!-- Budget -->
      <section id="view-budget" class="space-y-3 hidden">
        <div class="card">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold">×”×’×“×¨×ª ×ª×§×¦×™×‘×™× ×œ×¤×™ ×§×˜×’×•×¨×™×”</h3>
            <button id="addBudgetRow" class="pill bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-200">â• ×§×˜×’×•×¨×™×”</button>
          </div>
          <div class="space-y-2" id="budgetList"></div>
          <div class="mt-2 flex gap-2">
            <button id="saveBudgets" class="btn btn-primary flex-1">×©××™×¨×ª ×ª×§×¦×™×‘</button>
            <button id="resetBudgets" class="btn flex-1 bg-slate-200 dark:bg-slate-700">××™×¤×•×¡</button>
          </div>
        </div>
      </section>

      <!-- History -->
      <section id="view-history" class="space-y-3 hidden">
        <div class="card">
          <div class="flex gap-2 items-center">
            <input id="search" class="w-full rounded-2xl px-4 py-3 bg-white/80 dark:bg-slate-800/70 outline-none focus:ring-2 ring-brand" placeholder="×—×™×¤×•×© ×œ×¤×™ ×ª×™××•×¨/×§×˜×’×•×¨×™×”" />
            <select id="filterKind" class="rounded-2xl px-3 py-3 bg-white/80 dark:bg-slate-800/70">
              <option value="all">×”×›×œ</option>
              <option value="expense">×”×•×¦××•×ª</option>
              <option value="income">×”×›× ×¡×•×ª</option>
            </select>
          </div>
        </div>
        <div class="card">
          <div class="flex gap-2 mb-2">
            <button id="exportCSV" class="pill bg-indigo-100 text-indigo-700 dark:bg-indigo-900/40 dark:text-indigo-200">ğŸ“¤ ×™×™×¦×•× CSV</button>
            <button id="exportJSON" class="pill bg-indigo-100 text-indigo-700 dark:bg-indigo-900/40 dark:text-indigo-200">ğŸ“¤ ×™×™×¦×•× JSON</button>
            <label class="pill bg-slate-200 dark:bg-slate-700 cursor-pointer">ğŸ“¥ ×™×™×‘×•× JSON
              <input id="importJSON" type="file" accept="application/json" class="hidden" />
            </label>
            <button id="loadDemo" class="pill bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-200">× ×ª×•× ×™ ×”×“×’××”</button>
            <button id="clearAll" class="pill bg-rose-100 text-rose-700 dark:bg-rose-900/40 dark:text-rose-200">× ×™×§×•×™ ×”×›×œ</button>
          </div>
          <ul id="historyList" class="divide-y divide-slate-200 dark:divide-slate-800"></ul>
        </div>
      </section>
    </main>

    <!-- Bottom Nav -->
    <nav class="sticky bottom-0 z-30 bg-white/90 dark:bg-slate-800/80 backdrop-blur border-t border-slate-200/70 dark:border-slate-700/60">
      <div class="max-w-screen-sm mx-auto grid grid-cols-4">
        <button data-nav="add" class="tab px-3 py-3 text-sm border-t-2 border-transparent flex flex-col items-center gap-1 tab-active">â•<span>×”×•×¡×¤×”</span></button>
        <button data-nav="reports" class="tab px-3 py-3 text-sm border-t-2 border-transparent flex flex-col items-center gap-1">ğŸ“ˆ<span>×“×•×—×•×ª</span></button>
        <button data-nav="budget" class="tab px-3 py-3 text-sm border-t-2 border-transparent flex flex-col items-center gap-1">ğŸ’³<span>×ª×§×¦×™×‘</span></button>
        <button data-nav="history" class="tab px-3 py-3 text-sm border-t-2 border-transparent flex flex-col items-center gap-1">ğŸ—‚ï¸<span>×”×™×¡×˜×•×¨×™×”</span></button>
      </div>
    </nav>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast" hidden>
    <div class="px-4 py-2 rounded-full bg-slate-900 text-white dark:bg-black/80">× ×©××¨ ×‘×”×¦×œ×—×” âœ…</div>
  </div>

  <!-- Settings Modal (simple) -->
  <div id="settingsModal" class="fixed inset-0 bg-black/40 hidden items-end sm:items-center sm:justify-center">
    <div class="bg-white dark:bg-slate-800 w-full sm:max-w-md p-4 rounded-t-3xl sm:rounded-3xl space-y-3">
      <div class="flex items-center justify-between">
        <h3 class="font-semibold">×”×’×“×¨×•×ª</h3>
        <button id="closeSettings" class="pill bg-slate-100 dark:bg-slate-700">âœ–</button>
      </div>
      <div class="flex items-center justify-between">
        <div class="space-y-1">
          <div class="font-medium">××¦×‘ ×›×”×”</div>
          <div class="text-sm opacity-80">× ×•×— ×œ×¢×™× ×™×™× ×‘×©×¢×•×ª ×¢×¨×‘</div>
        </div>
        <label class="inline-flex items-center cursor-pointer">
          <input type="checkbox" id="darkToggle" class="sr-only peer">
          <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:bg-indigo-600 relative after:content-[''] after:absolute after:top-[2px] after:right-[2px] after:bg-white after:h-5 after:w-5 after:rounded-full after:transition-all peer-checked:after:-translate-x-full"></div>
        </label>
      </div>
      <div class="space-y-2">
        <div class="text-sm opacity-80">×’×¨×¡×” ×¨××©×•× ×™×ª â€¢ ××—×¡×•×Ÿ ××§×•××™ ×‘×“×¤×“×¤×Ÿ â€¢ ×™×™×¦×•× CSV/JSON ×‘×¢×‘×¨×™×ª</div>
      </div>
    </div>
  </div>

  <script>
  // ===== State & Storage =====
  const LS_KEYS = {
    entries: 'kk_entries',
    budgets: 'kk_budgets',
    categories: 'kk_categories',
    templates: 'kk_templates',
    theme: 'kk_theme'
  };

  const DEFAULTS = {
    categoriesExpense: ['××–×•×Ÿ','×‘×’×“×™×','×™×¦×™××•×ª','×ª×—×‘×•×¨×”','×§×•×¡××˜×™×§×”','×¡×¤×¨×™×/×œ×™××•×“×™×','×‘×™×œ×•×™×™×','×©×›×¨ ×“×™×¨×”','×¡×œ×•×œ×¨/××™× ×˜×¨× ×˜','×‘×¨×™××•×ª'],
    categoriesIncome: ['×¢×‘×•×“×”','××©×¤×—×”','××œ×’×•×ª','×¢×‘×•×“×•×ª ×¦×“'],
  };

  let state = {
    kind: 'expense', // 'expense' | 'income'
    entries: load(LS_KEYS.entries, []),
    budgets: load(LS_KEYS.budgets, {}),
    categories: load(LS_KEYS.categories, { expense: DEFAULTS.categoriesExpense, income: DEFAULTS.categoriesIncome }),
    templates: load(LS_KEYS.templates, []),
    theme: load(LS_KEYS.theme, (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light')),
    charts: { pie: null, line: null }
  };

  if (state.theme === 'dark') document.documentElement.classList.add('dark');

  // Demo data on very first run
  if (!localStorage.getItem('kk_has_booted')) {
    if (state.entries.length === 0) {
      seedDemo();
    }
    localStorage.setItem('kk_has_booted','1');
  }

  // ===== Utilities =====
  function load(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)) ?? fallback }catch(e){ return fallback } }
  function save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
  const fmtCurrency = (n)=> new Intl.NumberFormat('he-IL',{ style:'currency', currency:'ILS', maximumFractionDigits:2 }).format(n || 0);
  const todayStr = ()=> new Date().toISOString().slice(0,10);
  const sameMonth = (d, y = new Date().getFullYear(), m = new Date().getMonth()) => { const dt = new Date(d); return dt.getFullYear()===y && dt.getMonth()===m };
  const monthName = (d=new Date())=> new Intl.DateTimeFormat('he-IL',{ month:'long', year:'numeric'}).format(d);

  function toast(msg='× ×©××¨ ×‘×”×¦×œ×—×” âœ…'){
    const el = document.getElementById('toast');
    el.querySelector('div').textContent = msg;
    el.hidden = false; setTimeout(()=> el.hidden = true, 1400);
  }

  function uid(){ return Math.random().toString(36).slice(2) + Date.now().toString(36) }

  // ===== UI Wiring =====
  const monthLabel = document.getElementById('monthLabel');
  const amount = document.getElementById('amount');
  const category = document.getElementById('category');
  const dateEl = document.getElementById('date');
  const note = document.getElementById('note');
  const saveTemplate = document.getElementById('saveTemplate');
  const quickForm = document.getElementById('quickForm');
  const sumIncome = document.getElementById('sumIncome');
  const sumExpense = document.getElementById('sumExpense');
  const balance = document.getElementById('balance');
  const budgetGlance = document.getElementById('budgetGlance');
  const templatesCard = document.getElementById('templatesCard');
  const templatesList = document.getElementById('templatesList');
  const clearTemplates = document.getElementById('clearTemplates');

  const search = document.getElementById('search');
  const filterKind = document.getElementById('filterKind');
  const historyList = document.getElementById('historyList');

  const exportCSV = document.getElementById('exportCSV');
  const exportJSON = document.getElementById('exportJSON');
  const importJSON = document.getElementById('importJSON');
  const loadDemoBtn = document.getElementById('loadDemo');
  const clearAllBtn = document.getElementById('clearAll');

  const budgetList = document.getElementById('budgetList');
  const saveBudgets = document.getElementById('saveBudgets');
  const resetBudgets = document.getElementById('resetBudgets');
  const addBudgetRow = document.getElementById('addBudgetRow');

  const themeBtn = document.getElementById('themeBtn');
  const settingsBtn = document.getElementById('settingsBtn');
  const settingsModal = document.getElementById('settingsModal');
  const closeSettings = document.getElementById('closeSettings');
  const darkToggle = document.getElementById('darkToggle');

  // Tabs
  document.querySelectorAll('.tab').forEach(b=> b.addEventListener('click', ()=> switchView(b.dataset.nav)));
  document.querySelectorAll('[data-nav]')
    .forEach(b=>{ if(b.classList.contains('pill')) b.addEventListener('click',()=> switchView(b.dataset.nav)); });

  // Kind toggle
  document.querySelectorAll('.kindBtn').forEach(btn=> btn.addEventListener('click', ()=> setKind(btn.dataset.kind)));

  // Category add
  document.getElementById('addCategoryBtn').addEventListener('click', ()=>{
    const k = state.kind;
    const name = prompt('×©× ×§×˜×’×•×¨×™×” ×—×“×©×” ('+(k==='expense'?'×”×•×¦××”':'×”×›× ×¡×”')+')');
    if(!name) return;
    if(!state.categories[k].includes(name)){
      state.categories[k].push(name);
      save(LS_KEYS.categories, state.categories);
      buildCategories();
      category.value = name;
    }
  });

  // Quick Form
  quickForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    const amt = parseFloat(amount.value);
    if(!amt || amt<=0) { amount.focus(); return; }
    const entry = {
      id: uid(),
      date: dateEl.value || todayStr(),
      kind: state.kind,
      category: category.value,
      amount: +amt.toFixed(2),
      note: (note.value||'').trim()
    };
    state.entries.unshift(entry);
    save(LS_KEYS.entries, state.entries);

    if (saveTemplate.checked){
      state.templates.unshift({ kind:entry.kind, category:entry.category, note:entry.note||'', amount: entry.amount });
      state.templates = dedupTemplates(state.templates).slice(0,10);
      save(LS_KEYS.templates, state.templates);
      renderTemplates();
    }

    quickForm.reset();
    dateEl.value = todayStr();
    toast();
    refreshAll();
  });

  clearTemplates.addEventListener('click', ()=>{
    if(confirm('×œ××—×•×§ ××ª ×›×œ ×”×ª×‘× ×™×•×ª ×”×©××•×¨×•×ª?')){
      state.templates = []; save(LS_KEYS.templates, state.templates); renderTemplates();
    }
  });

  // History actions
  search.addEventListener('input', renderHistory);
  filterKind.addEventListener('change', renderHistory);

  // Export / Import
  exportCSV.addEventListener('click', ()=> downloadCSV());
  exportJSON.addEventListener('click', ()=> downloadJSON());
  importJSON.addEventListener('change', handleImportJSON);
  loadDemoBtn.addEventListener('click', ()=> { if(confirm('×œ×˜×¢×•×Ÿ × ×ª×•× ×™ ×”×“×’××”? ×¤×¢×•×œ×” ×–×• ×ª×•×¡×™×£ × ×ª×•× ×™×.')) { seedDemo(true); refreshAll(); }});
  clearAllBtn.addEventListener('click', ()=>{
    if(confirm('×œ××—×•×§ ××ª ×›×œ ×”× ×ª×•× ×™×? (××¤×©×¨ ×œ×’×‘×•×ª ×§×•×“× ×‘-JSON/CSV)')){
      state.entries=[]; save(LS_KEYS.entries, state.entries);
      state.budgets={}; save(LS_KEYS.budgets, state.budgets);
      toast('× ×•×§×” ×‘×”×¦×œ×—×” ğŸ§¹'); refreshAll();
    }
  });

  // Budgets
  saveBudgets.addEventListener('click', ()=>{
    const rows = budgetList.querySelectorAll('[data-row]');
    const next = {};
    rows.forEach(r=>{
      const cat = r.querySelector('input[name="cat"]').value.trim();
      const val = parseFloat(r.querySelector('input[name="amt"]').value);
      if(cat && val>0) next[cat] = +val.toFixed(2);
    });
    state.budgets = next; save(LS_KEYS.budgets, state.budgets);
    toast('×”×ª×§×¦×™×‘ × ×©××¨ ğŸ“Œ'); refreshAll();
  });

  resetBudgets.addEventListener('click', ()=>{ if(confirm('×œ××¤×¡ ×ª×§×¦×™×‘×™×?')){ state.budgets={}; save(LS_KEYS.budgets, state.budgets); refreshAll(); }});
  addBudgetRow.addEventListener('click', ()=> budgetList.appendChild(budgetRow('', '')));

  // Theme & Settings
  themeBtn.addEventListener('click', toggleTheme);
  settingsBtn.addEventListener('click', ()=> settingsModal.classList.remove('hidden'));
  closeSettings.addEventListener('click', ()=> settingsModal.classList.add('hidden'));
  settingsModal.addEventListener('click', (e)=>{ if(e.target===settingsModal) settingsModal.classList.add('hidden') });
  darkToggle.checked = state.theme==='dark';
  darkToggle.addEventListener('change', toggleTheme);

  function toggleTheme(){
    document.documentElement.classList.toggle('dark');
    state.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
    save(LS_KEYS.theme, state.theme);
  }

  // ===== Renderers =====
  function buildCategories(){
    const list = (state.kind==='expense' ? state.categories.expense : state.categories.income);
    category.innerHTML = list.map(c=>`<option>${c}</option>`).join('');
  }

  function setKind(k){ state.kind = k; document.querySelectorAll('.kindBtn').forEach(b=> b.classList.remove('ring-brand'));
    document.querySelector(`.kindBtn[data-kind="${k}"]`).classList.add('ring-brand');
    buildCategories();
  }

  function renderSnapshot(){
    const now = new Date();
    const monthEntries = state.entries.filter(e=> sameMonth(e.date, now.getFullYear(), now.getMonth()));
    const totalIncome = monthEntries.filter(e=>e.kind==='income').reduce((s,e)=> s+e.amount,0);
    const totalExpense = monthEntries.filter(e=>e.kind==='expense').reduce((s,e)=> s+e.amount,0);
    sumIncome.textContent = fmtCurrency(totalIncome);
    sumExpense.textContent = fmtCurrency(totalExpense);
    balance.textContent = fmtCurrency(totalIncome-totalExpense);
  }

  function renderBudgetGlance(){
    const now = new Date();
    const exp = state.entries.filter(e=> e.kind==='expense' && sameMonth(e.date, now.getFullYear(), now.getMonth()));
    const byCat = {};
    exp.forEach(e=> byCat[e.category] = (byCat[e.category]||0) + e.amount);

    const items = Object.entries(state.budgets).sort((a,b)=> (b[1]-a[1])).slice(0,6);
    const host = budgetGlance; host.innerHTML = '';
    if(items.length===0){ host.innerHTML = '<div class="text-sm opacity-70">×œ× ×”×•×’×“×¨×• ×ª×§×¦×™×‘×™× ×¢×“×™×™×Ÿ. ×¢×‘×¨×™ ×œ×œ×©×•× ×™×ª ×ª×§×¦×™×‘.</div>'; return; }
    items.forEach(([cat, limit])=>{
      const used = byCat[cat]||0; const pct = Math.min(100, Math.round(100*used/limit));
      const color = pct>=100? 'bg-rose-500' : pct>=80? 'bg-amber-500' : 'bg-indigo-500';
      const row = document.createElement('div');
      row.innerHTML = `
        <div class="flex justify-between text-sm mb-1"><span>${cat}</span><span>${fmtCurrency(used)} / ${fmtCurrency(limit)}</span></div>
        <div class="progress"><span class="${color}" style="width:${pct}%;"></span></div>`;
      host.appendChild(row);
    });
  }

  function renderTemplates(){
    const list = state.templates; const host = templatesList; host.innerHTML='';
    document.getElementById('templatesCard').hidden = list.length===0;
    list.forEach((t,i)=>{
      const b = document.createElement('button');
      b.className = 'pill bg-slate-100 dark:bg-slate-700 hover:bg-slate-200';
      b.textContent = `${t.kind==='expense'?'â¬‡ï¸':'â¬†ï¸'} ${t.category} â€“ ${fmtCurrency(t.amount)}` + (t.note?` â€¢ ${t.note}`:'');
      b.addEventListener('click',()=>{
        setKind(t.kind); buildCategories();
        category.value = t.category; amount.value = t.amount; note.value = t.note; dateEl.value = todayStr();
      });
      host.appendChild(b);
    });
  }

  function renderHistory(){
    const term = (search.value||'').trim();
    const kind = filterKind.value;
    const entries = state.entries.filter(e=>
      (kind==='all' || e.kind===kind) &&
      (term==='' || (e.category+" "+(e.note||'')).includes(term))
    );
    historyList.innerHTML = '';
    if(entries.length===0){ historyList.innerHTML = '<li class="py-6 text-center opacity-70">××™×Ÿ ×ª× ×•×¢×•×ª ×œ×”×¦×’×”</li>'; return; }
    entries.forEach(e=>{
      const li = document.createElement('li');
      li.className = 'py-3 flex items-center gap-3';
      li.innerHTML = `
        <div class="w-9 h-9 grid place-items-center rounded-2xl ${e.kind==='expense'?'bg-rose-100 text-rose-700':'bg-emerald-100 text-emerald-700'}">${e.kind==='expense'?'â¬‡ï¸':'â¬†ï¸'}</div>
        <div class="flex-1 min-w-0">
          <div class="flex justify-between items-baseline gap-2">
            <div class="font-medium truncate">${e.category}${e.note? ' â€¢ '+escapeHtml(e.note):''}</div>
            <div class="font-bold ${e.kind==='expense'?'text-rose-600':'text-emerald-600'}">${fmtCurrency(e.amount)}</div>
          </div>
          <div class="text-xs opacity-70">${new Intl.DateTimeFormat('he-IL').format(new Date(e.date))}</div>
        </div>
        <div class="flex items-center gap-1">
          <button class="pill bg-slate-100 dark:bg-slate-700" data-act="edit">×¢×¨×™×›×”</button>
          <button class="pill bg-rose-100 text-rose-700 dark:bg-rose-900/40 dark:text-rose-200" data-act="del">××—×™×§×”</button>
        </div>`;

      li.querySelector('[data-act="del"]').addEventListener('click',()=>{
        if(confirm('×œ××—×•×§ ×¤×¢×•×œ×” ×–×•?')){
          state.entries = state.entries.filter(x=> x.id!==e.id);
          save(LS_KEYS.entries, state.entries);
          renderHistory(); renderSnapshot(); renderBudgetGlance(); updateCharts();
        }
      });
      li.querySelector('[data-act="edit"]').addEventListener('click',()=> editEntry(e));
      historyList.appendChild(li);
    });
  }

  function editEntry(e){
    const newAmt = prompt('×¡×›×•× ×—×“×© (â‚ª)', e.amount);
    if(newAmt==null) return;
    const v = parseFloat(newAmt);
    if(!v || v<=0) return alert('×¡×›×•× ×œ× ×ª×§×™×Ÿ');
    e.amount = +v.toFixed(2);
    const newNote = prompt('×ª×™××•×¨ (××¤×©×¨ ×œ×”×©××™×¨ ×¨×™×§)', e.note||'');
    if(newNote!==null) e.note = newNote.trim();
    save(LS_KEYS.entries, state.entries);
    toast('×¢×•×“×›×Ÿ âœ”ï¸');
    renderHistory(); renderSnapshot(); renderBudgetGlance(); updateCharts();
  }

  function renderBudgets(){
    budgetList.innerHTML = '';
    const cats = Array.from(new Set([ ...state.categories.expense, ...Object.keys(state.budgets) ]));
    cats.forEach(c=> budgetList.appendChild(budgetRow(c, state.budgets[c]||'')) );
  }

  function budgetRow(cat, amt){
    const row = document.createElement('div'); row.dataset.row='1'; row.className='grid grid-cols-5 gap-2 items-center';
    row.innerHTML = `
      <input name="cat" class="col-span-3 rounded-2xl px-3 py-2 bg-white/80 dark:bg-slate-800/70" value="${cat||''}" placeholder="×©× ×§×˜×’×•×¨×™×”" />
      <input name="amt" type="number" min="0" step="0.01" class="col-span-2 rounded-2xl px-3 py-2 bg-white/80 dark:bg-slate-800/70" value="${amt}" placeholder="×ª×§×¦×™×‘ ×—×•×“×©×™ (â‚ª)" />`;
    return row;
  }

  function escapeHtml(s=''){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

  // ===== Charts =====
  function updateCharts(){
    const now = new Date();
    const month = state.entries.filter(e=> sameMonth(e.date, now.getFullYear(), now.getMonth()));
    const exp = month.filter(e=> e.kind==='expense');

    // Pie by category
    const byCat = {};
    exp.forEach(e=> byCat[e.category] = (byCat[e.category]||0)+e.amount);
    const pieData = { labels: Object.keys(byCat), datasets:[{ data: Object.values(byCat) }] };
    const pieEl = document.getElementById('pieCats');
    state.charts.pie && state.charts.pie.destroy();
    state.charts.pie = new Chart(pieEl, { type:'doughnut', data: pieData, options:{ plugins:{ legend:{ position:'bottom' } } } });

    // Line daily net
    const map = new Map();
    month.forEach(e=>{
      const d = e.date.slice(0,10);
      const val = (e.kind==='income'? e.amount : -e.amount);
      map.set(d, (map.get(d)||0) + val);
    });
    const days = Array.from(map.keys()).sort();
    const lineData = { labels: days, datasets:[{ label:'× ×˜×• ×™×•××™', data: days.map(d=> +map.get(d).toFixed(2) ) }] };
    const lineEl = document.getElementById('lineDaily');
    state.charts.line && state.charts.line.destroy();
    state.charts.line = new Chart(lineEl, { type:'line', data: lineData, options:{ scales:{ y:{ ticks:{ callback:(v)=> 'â‚ª'+v } } } } });
  }

  // ===== Export / Import =====
  function downloadCSV(){
    const rows = [ ['×ª××¨×™×š','×¡×•×’','×ª×™××•×¨','×§×˜×’×•×¨×™×”','×¡×›×•×'] ];
    state.entries.slice().reverse().forEach(e=>{
      rows.push([ e.date, (e.kind==='expense'?'×”×•×¦××”':'×”×›× ×¡×”'), e.note||'', e.category, e.amount ]);
    });
    const csv = rows.map(r=> r.map(v=> '"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
    const blob = new Blob(['\uFEFF'+csv], { type:'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    triggerDownload(url, `×§×•×¤×”-×§×œ×”-×™×™×¦×•×-${new Date().toISOString().slice(0,7)}.csv`);
  }

  function downloadJSON(){
    const blob = new Blob([ JSON.stringify({ entries: state.entries, budgets: state.budgets, categories: state.categories }, null, 2) ], { type:'application/json' });
    const url = URL.createObjectURL(blob);
    triggerDownload(url, `×§×•×¤×”-×§×œ×”-×’×™×‘×•×™-${Date.now()}.json`);
  }

  function triggerDownload(url, filename){
    const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  async function handleImportJSON(e){
    const file = e.target.files[0]; if(!file) return; const text = await file.text();
    try{
      const obj = JSON.parse(text);
      if(obj.entries){ state.entries = obj.entries; save(LS_KEYS.entries, state.entries); }
      if(obj.budgets){ state.budgets = obj.budgets; save(LS_KEYS.budgets, state.budgets); }
      if(obj.categories){ state.categories = obj.categories; save(LS_KEYS.categories, state.categories); }
      toast('×”× ×ª×•× ×™× ×™×•×‘××• ×‘×”×¦×œ×—×”');
      refreshAll();
    }catch(err){ alert('×§×•×‘×¥ ×œ× ×ª×§×™×Ÿ'); }
    importJSON.value = '';
  }

  // ===== Demo Seed =====
  function seedDemo(append=false){
    const base = [
      {date: todayStr(), kind:'expense', category:'××–×•×Ÿ', amount: 32.5, note:'×§×¤×” ×•×›×¨×™×š'},
      {date: todayStr(), kind:'expense', category:'×ª×—×‘×•×¨×”', amount: 12.0, note:'×¨×‘ ×§×•'},
      {date: todayStr(), kind:'income', category:'×¢×‘×•×“×”', amount: 450.0, note:'××©××¨×ª ×©×™×©×™'},
      {date: todayStr(), kind:'expense', category:'×‘×’×“×™×', amount: 129.9, note:'×˜×™-×©×™×¨×˜'},
      {date: todayStr(), kind:'expense', category:'×‘×™×œ×•×™×™×', amount: 55.0, note:'×¡×¨×˜'},
      {date: todayStr(), kind:'income', category:'××©×¤×—×”', amount: 200.0, note:'×¢×–×¨×” ××”×”×•×¨×™×'},
    ];
    state.entries = append ? base.concat(state.entries) : base;
    state.budgets = { '××–×•×Ÿ': 900, '×ª×—×‘×•×¨×”': 250, '×‘×’×“×™×': 300, '×‘×™×œ×•×™×™×': 400, '×¡×¤×¨×™×/×œ×™××•×“×™×': 150 };
    save(LS_KEYS.entries, state.entries);
    save(LS_KEYS.budgets, state.budgets);
    save(LS_KEYS.categories, state.categories);
    state.templates = [
      {kind:'expense', category:'×©×›×¨ ×“×™×¨×”', amount: 1800, note:''},
      {kind:'expense', category:'×¡×œ×•×œ×¨/××™× ×˜×¨× ×˜', amount: 89, note:'×—×•×“×©×™'},
      {kind:'income', category:'×¢×‘×•×“×”', amount: 450, note:'××©××¨×ª'},
    ];
    save(LS_KEYS.templates, state.templates);
  }

  function dedupTemplates(list){
    const key = (t)=> [t.kind,t.category,t.note].join('|');
    const seen = new Set();
    return list.filter(t=> (seen.has(key(t))?false: (seen.add(key(t)),true)) );
  }

  // ===== View switching =====
  function switchView(id){
    document.querySelectorAll('main section').forEach(s=> s.classList.add('hidden'));
    document.getElementById('view-'+id).classList.remove('hidden');
    document.querySelectorAll('nav .tab').forEach(t=> t.classList.remove('tab-active'));
    document.querySelector('nav .tab[data-nav="'+id+'"]').classList.add('tab-active');
    if(id==='reports') updateCharts();
    if(id==='budget') renderBudgets();
    if(id==='history') renderHistory();
    window.scrollTo({top:0, behavior:'smooth'});
  }

  function refreshAll(){
    monthLabel.textContent = '×—×•×“×© × ×•×›×—×™: ' + monthName();
    setKind(state.kind);
    buildCategories();
    dateEl.value = todayStr();
    renderSnapshot();
    renderBudgetGlance();
    renderTemplates();
    renderHistory();
    if(!document.getElementById('view-reports').classList.contains('hidden')) updateCharts();
  }

  // ===== Boot =====
  refreshAll();

  </script>
</body>
</html>
