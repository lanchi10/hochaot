<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>כיס קטן - אפליקציה לניהול הוצאות אישיות</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Heebo', Arial, sans-serif;
        }
        
        select {
            color: #1f2937 !important;
            background-color: white !important;
        }
        
        select option {
            color: #1f2937 !important;
            background-color: white !important;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .tab-button.active {
            background-color: #3b82f6;
            color: white;
        }
        
        .expense-item {
            transition: all 0.3s ease;
        }
        
        .expense-item:hover {
            background-color: #f3f4f6;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        @media print {
            body { print-color-adjust: exact; }
            .no-print { display: none !important; }
            .chart-container { height: 250px !important; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-4xl">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="text-center">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">
                    <i class="fas fa-wallet text-blue-500 mr-3"></i>
                    כיס קטן
                </h1>
                <p class="text-gray-600">ניהול הוצאות אישיות פשוט ואפקטיבי</p>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="bg-white rounded-lg shadow-md mb-6">
            <div class="flex flex-wrap justify-center">
                <button class="tab-button active px-6 py-3 font-medium rounded-t-lg" onclick="showTab('expenses')">
                    <i class="fas fa-plus-circle mr-2"></i>הוצאות
                </button>
                <button class="tab-button px-6 py-3 font-medium rounded-t-lg" onclick="showTab('categories')">
                    <i class="fas fa-tags mr-2"></i>קטגוריות
                </button>
                <button class="tab-button px-6 py-3 font-medium rounded-t-lg" onclick="showTab('reports')">
                    <i class="fas fa-chart-bar mr-2"></i>דוחות
                </button>
                <button class="tab-button px-6 py-3 font-medium rounded-t-lg" onclick="showTab('charts')">
                    <i class="fas fa-chart-pie mr-2"></i>גרפים
                </button>
                <button class="tab-button px-6 py-3 font-medium rounded-t-lg" onclick="showTab('export')">
                    <i class="fas fa-download mr-2"></i>ייצוא
                </button>
            </div>
        </div>

        <!-- Expenses Tab -->
        <div id="expenses" class="tab-content active">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-bold mb-4">הוספת הוצאה חדשה</h2>
                <form id="expenseForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">סכום (₪)</label>
                        <input type="number" id="amount" step="0.01" min="0" required 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">תיאור</label>
                        <input type="text" id="description" required 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="לדוגמה: קפה הפוך, חטיף שוקולד">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">קטגוריה</label>
                        <select id="category" required 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-900 bg-white">
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">תאריך</label>
                        <input type="date" id="date" required 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <button type="submit" class="w-full bg-blue-500 text-white py-3 px-4 rounded-lg hover:bg-blue-600 transition duration-200">
                        <i class="fas fa-plus mr-2"></i>הוספת הוצאה
                    </button>
                </form>
            </div>

            <!-- Recent Expenses -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">הוצאות אחרונות</h2>
                    <div class="flex space-x-2">
                        <select id="filterCategory" class="p-2 border border-gray-300 rounded text-gray-900 bg-white">
                            <option value="">כל הקטגוריות</option>
                        </select>
                        <select id="sortBy" class="p-2 border border-gray-300 rounded text-gray-900 bg-white">
                            <option value="date-desc">תאריך (חדש לישן)</option>
                            <option value="date-asc">תאריך (ישן לחדש)</option>
                            <option value="amount-desc">סכום (גבוה לנמוך)</option>
                            <option value="amount-asc">סכום (נמוך לגבוה)</option>
                        </select>
                    </div>
                </div>
                <div id="expensesList" class="space-y-3"></div>
            </div>
        </div>

        <!-- Categories Tab -->
        <div id="categories" class="tab-content">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-bold mb-4">ניהול קטגוריות</h2>
                <form id="categoryForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">שם הקטגוריה</label>
                        <input type="text" id="categoryName" required 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="לדוגמה: תחבורה, בידור">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">צבע הקטגוריה</label>
                        <input type="color" id="categoryColor" 
                               class="w-full h-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <button type="submit" class="w-full bg-green-500 text-white py-3 px-4 rounded-lg hover:bg-green-600 transition duration-200">
                        <i class="fas fa-plus mr-2"></i>הוספת קטגוריה
                    </button>
                </form>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-4">קטגוריות קיימות</h2>
                <div id="categoriesList" class="space-y-3"></div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports" class="tab-content">
            <div class="grid md:grid-cols-3 gap-6 mb-6">
                <div class="bg-white rounded-lg shadow-md p-6 text-center">
                    <h3 class="text-lg font-bold text-blue-600 mb-2">השבוע</h3>
                    <p class="text-3xl font-bold text-gray-800" id="weeklyTotal">₪0</p>
                    <p class="text-sm text-gray-600" id="weeklyRange"></p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6 text-center">
                    <h3 class="text-lg font-bold text-green-600 mb-2">החודש</h3>
                    <p class="text-3xl font-bold text-gray-800" id="monthlyTotal">₪0</p>
                    <p class="text-sm text-gray-600" id="monthlyRange"></p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6 text-center">
                    <h3 class="text-lg font-bold text-purple-600 mb-2">השנה</h3>
                    <p class="text-3xl font-bold text-gray-800" id="yearlyTotal">₪0</p>
                    <p class="text-sm text-gray-600" id="yearlyRange"></p>
                </div>
            </div>

            <!-- Detailed Reports -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-4">דוח מפורט לפי קטגוריות</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">תקופה</label>
                        <select id="reportPeriod" class="w-full p-3 border border-gray-300 rounded-lg text-gray-900 bg-white">
                            <option value="week">השבוע הנוכחי</option>
                            <option value="month">החודש הנוכחי</option>
                            <option value="year">השנה הנוכחית</option>
                        </select>
                    </div>
                </div>
                <div id="categoryReport" class="mt-6"></div>
            </div>
        </div>

        <!-- Charts Tab -->
        <div id="charts" class="tab-content">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-bold mb-4">התפלגות הוצאות לפי קטגוריות</h2>
                <div class="chart-container">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-4">מגמת הוצאות לאורך זמן</h2>
                <div class="chart-container">
                    <canvas id="lineChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Export Tab -->
        <div id="export" class="tab-content">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-4">ייצוא וגיבוי נתונים</h2>
                <div class="space-y-4">
                    <div>
                        <h3 class="text-lg font-semibold mb-2">ייצוא נתונים</h3>
                        <div class="flex flex-wrap gap-3">
                            <button onclick="exportToCSV()" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition duration-200">
                                <i class="fas fa-file-csv mr-2"></i>ייצוא ל-CSV
                            </button>
                            <button onclick="exportToJSON()" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition duration-200">
                                <i class="fas fa-file-code mr-2"></i>ייצוא ל-JSON
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-semibold mb-2">ייבוא נתונים</h3>
                        <div class="space-y-3">
                            <input type="file" id="importFile" accept=".json,.csv" class="w-full p-3 border border-gray-300 rounded-lg">
                            <button onclick="importData()" class="bg-purple-500 text-white px-6 py-3 rounded-lg hover:bg-purple-600 transition duration-200">
                                <i class="fas fa-file-import mr-2"></i>ייבוא נתונים
                            </button>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-semibold mb-2">נתוני סיכום</h3>
                        <div class="bg-gray-100 p-4 rounded-lg">
                            <p>סה"כ הוצאות: <span id="totalExpenses" class="font-bold">0</span></p>
                            <p>מספר רשומות: <span id="totalRecords" class="font-bold">0</span></p>
                            <p>קטגוריות: <span id="totalCategories" class="font-bold">0</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Expense Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">עריכת הוצאה</h2>
                <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="editExpenseForm" class="space-y-4">
                <input type="hidden" id="editExpenseId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">סכום (₪)</label>
                    <input type="number" id="editAmount" step="0.01" min="0" required 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">תיאור</label>
                    <input type="text" id="editDescription" required 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">קטגוריה</label>
                    <select id="editCategory" required 
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-900 bg-white">
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">תאריך</label>
                    <input type="date" id="editDate" required 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div class="flex space-x-3">
                    <button type="submit" class="flex-1 bg-blue-500 text-white py-3 px-4 rounded-lg hover:bg-blue-600 transition duration-200">
                        <i class="fas fa-save mr-2"></i>שמירה
                    </button>
                    <button type="button" onclick="closeEditModal()" class="flex-1 bg-gray-500 text-white py-3 px-4 rounded-lg hover:bg-gray-600 transition duration-200">
                        ביטול
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Category Modal -->
    <div id="editCategoryModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">עריכת קטגוריה</h2>
                <button onclick="closeEditCategoryModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="editCategoryForm" class="space-y-4">
                <input type="hidden" id="editCategoryId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">שם הקטגוריה</label>
                    <input type="text" id="editCategoryName" required 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">צבע הקטגוריה</label>
                    <input type="color" id="editCategoryColorInput" 
                           class="w-full h-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div class="flex space-x-3">
                    <button type="submit" class="flex-1 bg-blue-500 text-white py-3 px-4 rounded-lg hover:bg-blue-600 transition duration-200">
                        <i class="fas fa-save mr-2"></i>שמירה
                    </button>
                    <button type="button" onclick="closeEditCategoryModal()" class="flex-1 bg-gray-500 text-white py-3 px-4 rounded-lg hover:bg-gray-600 transition duration-200">
                        ביטול
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
        let categories = JSON.parse(localStorage.getItem('categories')) || [
            { id: 1, name: 'קפה', color: '#8B4513' },
            { id: 2, name: 'אוכל/נישנושים', color: '#FF6347' },
            { id: 3, name: 'פינוקים', color: '#FFD700' },
            { id: 4, name: 'אחר', color: '#808080' }
        ];
        let pieChart, lineChart;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            loadCategories();
            displayExpenses();
            updateReports();
            displayCategories();
            updateSummary();
            initializeCharts();
            
            // Set today's date as default
            document.getElementById('date').valueAsDate = new Date();
            
            // Event listeners
            document.getElementById('expenseForm').addEventListener('submit', addExpense);
            document.getElementById('categoryForm').addEventListener('submit', addCategory);
            document.getElementById('editExpenseForm').addEventListener('submit', updateExpense);
            document.getElementById('editCategoryForm').addEventListener('submit', updateCategory);
            document.getElementById('filterCategory').addEventListener('change', displayExpenses);
            document.getElementById('sortBy').addEventListener('change', displayExpenses);
            document.getElementById('reportPeriod').addEventListener('change', updateCategoryReport);
        }

        // Tab management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab and mark button as active
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Update charts when charts tab is shown
            if (tabName === 'charts') {
                setTimeout(() => {
                    updateCharts();
                }, 100);
            }
            
            // Update category report when reports tab is shown
            if (tabName === 'reports') {
                updateCategoryReport();
            }
        }

        // Category management
        function loadCategories() {
            const categorySelect = document.getElementById('category');
            const editCategorySelect = document.getElementById('editCategory');
            const filterSelect = document.getElementById('filterCategory');
            
            // Clear existing options
            categorySelect.innerHTML = '';
            editCategorySelect.innerHTML = '';
            filterSelect.innerHTML = '<option value="">כל הקטגוריות</option>';
            
            categories.forEach(category => {
                const option = new Option(category.name, category.id);
                const editOption = new Option(category.name, category.id);
                const filterOption = new Option(category.name, category.id);
                
                categorySelect.add(option);
                editCategorySelect.add(editOption);
                filterSelect.add(filterOption);
            });
        }

        function addCategory(e) {
            e.preventDefault();
            
            const name = document.getElementById('categoryName').value.trim();
            const color = document.getElementById('categoryColor').value;
            
            if (name) {
                const newCategory = {
                    id: Date.now(),
                    name: name,
                    color: color
                };
                
                categories.push(newCategory);
                localStorage.setItem('categories', JSON.stringify(categories));
                
                loadCategories();
                displayCategories();
                updateSummary();
                
                // Reset form
                document.getElementById('categoryForm').reset();
                
                alert('קטגוריה נוספה בהצלחה!');
            }
        }

        function displayCategories() {
            const container = document.getElementById('categoriesList');
            container.innerHTML = '';
            
            categories.forEach(category => {
                const categoryElement = document.createElement('div');
                categoryElement.className = 'flex items-center justify-between p-4 border border-gray-200 rounded-lg';
                categoryElement.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-6 h-6 rounded-full mr-3" style="background-color: ${category.color}"></div>
                        <span class="font-medium">${category.name}</span>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="editCategory(${category.id})" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteCategory(${category.id})" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                container.appendChild(categoryElement);
            });
        }

        function editCategory(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            if (category) {
                document.getElementById('editCategoryId').value = category.id;
                document.getElementById('editCategoryName').value = category.name;
                document.getElementById('editCategoryColorInput').value = category.color;
                
                document.getElementById('editCategoryModal').classList.add('show');
            }
        }

        function updateCategory(e) {
            e.preventDefault();
            
            const categoryId = parseInt(document.getElementById('editCategoryId').value);
            const name = document.getElementById('editCategoryName').value.trim();
            const color = document.getElementById('editCategoryColorInput').value;
            
            const categoryIndex = categories.findIndex(c => c.id === categoryId);
            if (categoryIndex !== -1) {
                categories[categoryIndex].name = name;
                categories[categoryIndex].color = color;
                
                localStorage.setItem('categories', JSON.stringify(categories));
                
                loadCategories();
                displayCategories();
                displayExpenses();
                updateCharts();
                
                closeEditCategoryModal();
                alert('קטגוריה עודכנה בהצלחה!');
            }
        }

        function deleteCategory(categoryId) {
            if (confirm('האם אתה בטוח שברצונך למחוק את הקטגוריה? הוצאות הקשורות לקטגוריה זו יועברו לקטגוריית "אחר".')) {
                // Find "Other" category or create it
                let otherCategory = categories.find(c => c.name === 'אחר');
                if (!otherCategory) {
                    otherCategory = { id: Date.now(), name: 'אחר', color: '#808080' };
                    categories.push(otherCategory);
                }
                
                // Update expenses with deleted category
                expenses.forEach(expense => {
                    if (expense.categoryId === categoryId) {
                        expense.categoryId = otherCategory.id;
                    }
                });
                
                // Remove category
                categories = categories.filter(c => c.id !== categoryId);
                
                localStorage.setItem('categories', JSON.stringify(categories));
                localStorage.setItem('expenses', JSON.stringify(expenses));
                
                loadCategories();
                displayCategories();
                displayExpenses();
                updateCharts();
                updateSummary();
                
                alert('קטגוריה נמחקה בהצלחה!');
            }
        }

        function closeEditCategoryModal() {
            document.getElementById('editCategoryModal').classList.remove('show');
        }

        // Expense management
        function addExpense(e) {
            e.preventDefault();
            
            const amount = parseFloat(document.getElementById('amount').value);
            const description = document.getElementById('description').value.trim();
            const categoryId = parseInt(document.getElementById('category').value);
            const date = document.getElementById('date').value;
            
            const newExpense = {
                id: Date.now(),
                amount: amount,
                description: description,
                categoryId: categoryId,
                date: date
            };
            
            expenses.push(newExpense);
            localStorage.setItem('expenses', JSON.stringify(expenses));
            
            displayExpenses();
            updateReports();
            updateCharts();
            updateSummary();
            
            // Reset form
            document.getElementById('expenseForm').reset();
            document.getElementById('date').valueAsDate = new Date();
            
            alert('הוצאה נוספה בהצלחה!');
        }

        function displayExpenses() {
            const container = document.getElementById('expensesList');
            const filterCategory = document.getElementById('filterCategory').value;
            const sortBy = document.getElementById('sortBy').value;
            
            let filteredExpenses = expenses;
            
            // Filter by category
            if (filterCategory) {
                filteredExpenses = expenses.filter(expense => expense.categoryId == filterCategory);
            }
            
            // Sort expenses
            filteredExpenses.sort((a, b) => {
                switch (sortBy) {
                    case 'date-desc':
                        return new Date(b.date) - new Date(a.date);
                    case 'date-asc':
                        return new Date(a.date) - new Date(b.date);
                    case 'amount-desc':
                        return b.amount - a.amount;
                    case 'amount-asc':
                        return a.amount - b.amount;
                    default:
                        return new Date(b.date) - new Date(a.date);
                }
            });
            
            container.innerHTML = '';
            
            if (filteredExpenses.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">אין הוצאות להצגה</p>';
                return;
            }
            
            filteredExpenses.forEach(expense => {
                const category = categories.find(c => c.id === expense.categoryId);
                const expenseElement = document.createElement('div');
                expenseElement.className = 'expense-item flex items-center justify-between p-4 border border-gray-200 rounded-lg';
                expenseElement.innerHTML = `
                    <div class="flex items-center flex-1">
                        <div class="w-4 h-4 rounded-full mr-3" style="background-color: ${category?.color || '#808080'}"></div>
                        <div class="flex-1">
                            <div class="font-medium">${expense.description}</div>
                            <div class="text-sm text-gray-600">${category?.name || 'לא ידוע'} • ${formatDate(expense.date)}</div>
                        </div>
                        <div class="text-lg font-bold text-gray-800 mr-4">₪${expense.amount.toFixed(2)}</div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="editExpense(${expense.id})" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteExpense(${expense.id})" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                container.appendChild(expenseElement);
            });
        }

        function editExpense(expenseId) {
            const expense = expenses.find(e => e.id === expenseId);
            if (expense) {
                document.getElementById('editExpenseId').value = expense.id;
                document.getElementById('editAmount').value = expense.amount;
                document.getElementById('editDescription').value = expense.description;
                document.getElementById('editCategory').value = expense.categoryId;
                document.getElementById('editDate').value = expense.date;
                
                document.getElementById('editModal').classList.add('show');
            }
        }

        function updateExpense(e) {
            e.preventDefault();
            
            const expenseId = parseInt(document.getElementById('editExpenseId').value);
            const amount = parseFloat(document.getElementById('editAmount').value);
            const description = document.getElementById('editDescription').value.trim();
            const categoryId = parseInt(document.getElementById('editCategory').value);
            const date = document.getElementById('editDate').value;
            
            const expenseIndex = expenses.findIndex(e => e.id === expenseId);
            if (expenseIndex !== -1) {
                expenses[expenseIndex] = {
                    ...expenses[expenseIndex],
                    amount: amount,
                    description: description,
                    categoryId: categoryId,
                    date: date
                };
                
                localStorage.setItem('expenses', JSON.stringify(expenses));
                
                displayExpenses();
                updateReports();
                updateCharts();
                
                closeEditModal();
                alert('הוצאה עודכנה בהצלחה!');
            }
        }

        function deleteExpense(expenseId) {
            if (confirm('האם אתה בטוח שברצונך למחוק את ההוצאה?')) {
                expenses = expenses.filter(e => e.id !== expenseId);
                localStorage.setItem('expenses', JSON.stringify(expenses));
                
                displayExpenses();
                updateReports();
                updateCharts();
                updateSummary();
                
                alert('הוצאה נמחקה בהצלחה!');
            }
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
        }

        // Reports
        function updateReports() {
            const now = new Date();
            
            // Weekly report
            const weekStart = new Date(now);
            weekStart.setDate(now.getDate() - now.getDay());
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            
            const weeklyExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate >= weekStart && expenseDate <= weekEnd;
            });
            const weeklyTotal = weeklyExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            
            document.getElementById('weeklyTotal').textContent = `₪${weeklyTotal.toFixed(2)}`;
            document.getElementById('weeklyRange').textContent = `${formatDate(weekStart.toISOString().split('T')[0])} - ${formatDate(weekEnd.toISOString().split('T')[0])}`;
            
            // Monthly report
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            
            const monthlyExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate >= monthStart && expenseDate <= monthEnd;
            });
            const monthlyTotal = monthlyExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            
            document.getElementById('monthlyTotal').textContent = `₪${monthlyTotal.toFixed(2)}`;
            document.getElementById('monthlyRange').textContent = `${formatDate(monthStart.toISOString().split('T')[0])} - ${formatDate(monthEnd.toISOString().split('T')[0])}`;
            
            // Yearly report
            const yearStart = new Date(now.getFullYear(), 0, 1);
            const yearEnd = new Date(now.getFullYear(), 11, 31);
            
            const yearlyExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate >= yearStart && expenseDate <= yearEnd;
            });
            const yearlyTotal = yearlyExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            
            document.getElementById('yearlyTotal').textContent = `₪${yearlyTotal.toFixed(2)}`;
            document.getElementById('yearlyRange').textContent = `${now.getFullYear()}`;
            
            updateCategoryReport();
        }

        function updateCategoryReport() {
            const period = document.getElementById('reportPeriod').value;
            const now = new Date();
            let startDate, endDate;
            
            switch (period) {
                case 'week':
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - now.getDay());
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now.getFullYear(), 11, 31);
                    break;
            }
            
            const periodExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate >= startDate && expenseDate <= endDate;
            });
            
            const categoryTotals = {};
            periodExpenses.forEach(expense => {
                const category = categories.find(c => c.id === expense.categoryId);
                const categoryName = category ? category.name : 'לא ידוע';
                categoryTotals[categoryName] = (categoryTotals[categoryName] || 0) + expense.amount;
            });
            
            const container = document.getElementById('categoryReport');
            container.innerHTML = '';
            
            if (Object.keys(categoryTotals).length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">אין הוצאות לתקופה זו</p>';
                return;
            }
            
            Object.entries(categoryTotals)
                .sort(([,a], [,b]) => b - a)
                .forEach(([categoryName, total]) => {
                    const category = categories.find(c => c.name === categoryName);
                    const percentage = (total / Object.values(categoryTotals).reduce((sum, val) => sum + val, 0) * 100).toFixed(1);
                    
                    const reportItem = document.createElement('div');
                    reportItem.className = 'flex items-center justify-between p-4 border border-gray-200 rounded-lg mb-3';
                    reportItem.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-4 h-4 rounded-full mr-3" style="background-color: ${category?.color || '#808080'}"></div>
                            <span class="font-medium">${categoryName}</span>
                        </div>
                        <div class="text-left">
                            <div class="font-bold">₪${total.toFixed(2)}</div>
                            <div class="text-sm text-gray-600">${percentage}%</div>
                        </div>
                    `;
                    container.appendChild(reportItem);
                });
        }

        // Charts
        function initializeCharts() {
            const pieCtx = document.getElementById('pieChart').getContext('2d');
            const lineCtx = document.getElementById('lineChart').getContext('2d');
            
            pieChart = new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: []
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            lineChart = new Chart(lineCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'הוצאות יומיות',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '₪' + value;
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
            
            updateCharts();
        }

        function updateCharts() {
            if (!pieChart || !lineChart) return;
            
            // Update pie chart
            const categoryTotals = {};
            expenses.forEach(expense => {
                const category = categories.find(c => c.id === expense.categoryId);
                const categoryName = category ? category.name : 'לא ידוע';
                categoryTotals[categoryName] = (categoryTotals[categoryName] || 0) + expense.amount;
            });
            
            const pieLabels = Object.keys(categoryTotals);
            const pieData = Object.values(categoryTotals);
            const pieColors = pieLabels.map(label => {
                const category = categories.find(c => c.name === label);
                return category ? category.color : '#808080';
            });
            
            pieChart.data.labels = pieLabels;
            pieChart.data.datasets[0].data = pieData;
            pieChart.data.datasets[0].backgroundColor = pieColors;
            pieChart.update();
            
            // Update line chart
            const last30Days = [];
            const dailyTotals = {};
            
            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                last30Days.push(formatDate(dateStr));
                dailyTotals[dateStr] = 0;
            }
            
            expenses.forEach(expense => {
                if (dailyTotals.hasOwnProperty(expense.date)) {
                    dailyTotals[expense.date] += expense.amount;
                }
            });
            
            lineChart.data.labels = last30Days;
            lineChart.data.datasets[0].data = Object.values(dailyTotals);
            lineChart.update();
        }

        // Export/Import
        function exportToCSV() {
            let csv = 'תאריך,תיאור,קטגוריה,סכום\n';
            
            expenses.forEach(expense => {
                const category = categories.find(c => c.id === expense.categoryId);
                csv += `${expense.date},"${expense.description}","${category?.name || 'לא ידוע'}",${expense.amount}\n`;
            });
            
            downloadFile(csv, 'expenses.csv', 'text/csv');
        }

        function exportToJSON() {
            const data = {
                expenses: expenses,
                categories: categories,
                exportDate: new Date().toISOString()
            };
            
            downloadFile(JSON.stringify(data, null, 2), 'expenses.json', 'application/json');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function importData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('אנא בחר קובץ לייבוא');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    
                    if (file.name.endsWith('.json')) {
                        const data = JSON.parse(content);
                        if (data.expenses && data.categories) {
                            expenses = data.expenses;
                            categories = data.categories;
                            
                            localStorage.setItem('expenses', JSON.stringify(expenses));
                            localStorage.setItem('categories', JSON.stringify(categories));
                            
                            initializeApp();
                            alert('נתונים יובאו בהצלחה!');
                        } else {
                            alert('פורמט הקובץ אינו תקין');
                        }
                    } else if (file.name.endsWith('.csv')) {
                        // Basic CSV import (simplified)
                        alert('ייבוא CSV יתמך בגרסאות עתידיות');
                    }
                } catch (error) {
                    alert('שגיאה בקריאת הקובץ: ' + error.message);
                }
            };
            
            reader.readAsText(file);
        }

        function updateSummary() {
            const totalAmount = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            document.getElementById('totalExpenses').textContent = `₪${totalAmount.toFixed(2)}`;
            document.getElementById('totalRecords').textContent = expenses.length;
            document.getElementById('totalCategories').textContent = categories.length;
        }

        // Utility functions
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('he-IL');
        }

        // Save data to localStorage whenever data changes
        function saveData() {
            localStorage.setItem('expenses', JSON.stringify(expenses));
            localStorage.setItem('categories', JSON.stringify(categories));
        }
    </script>
</body>
</html>
